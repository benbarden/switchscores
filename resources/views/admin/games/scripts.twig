<script>
    var formMode = '{{ FormMode }}';
    var formVals = [];

    if (formMode == 'edit') {

        // This is used when editing existing games.
        // *** Main *** //
        formVals['title'] = "{{ GameData.title|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        formVals['link_title'] = "{{ GameData.link_title }}";
        // *** Dates *** //
        {% for key,value in RegionList %}
        formVals['release_date_{{ key }}'] = "{{ attribute(attribute(GameReleaseDates, key), 'release_date') }}";
        formVals['upcoming_date_{{ key }}'] = "{{ attribute(attribute(GameReleaseDates, key), 'upcoming_date') }}";
        formVals['is_released_{{ key }}'] = "{{ attribute(attribute(GameReleaseDates, key), 'is_released') }}";
        {% endfor %}
        // *** eShop *** //
        formVals['price_eshop'] = "{{ GameData.price_eshop }}";
        formVals['players'] = "{{ GameData.players }}";
        // *** Additional *** //
        formVals['developer'] = "{{ GameData.developer|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        formVals['publisher'] = "{{ GameData.publisher|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        formVals['amazon_uk_link'] = "{{ GameData.amazon_uk_link }}";
        formVals['overview'] = "{{ GameData.overview|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        // *** Media *** //
        formVals['media_folder'] = "{{ GameData.media_folder }}";
        formVals['video_url'] = "{{ GameData.video_url }}";
        formVals['boxart_square_url'] = "{{ GameData.boxart_square_url }}";
        formVals['vendor_page_url'] = "{{ GameData.vendor_page_url }}";
        formVals['nintendo_page_url'] = "{{ GameData.nintendo_page_url }}";
        formVals['twitter_id'] = "{{ GameData.twitter_id }}";
        formVals['eshop_europe_fs_id'] = "{{ GameData.eshop_europe_fs_id }}";

    } else {

        // This is used for new games.
        // It's also used when submitting the edit version, to avoid the DB data overwriting the form.
        // *** Main *** //
        formVals['title'] = "{{ old('title')|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        formVals['link_title'] = "{{ old('link_title') }}";
        // *** Dates *** //
        {% for key,value in RegionList %}
        formVals['release_date_{{ key }}'] = "{{ old('release_date_'~key) }}";
        formVals['upcoming_date_{{ key }}'] = "{{ old('upcoming_date_'~key) }}";
        formVals['is_released_{{ key }}'] = "{{ old('is_released_'~key) }}";
        {% endfor %}
        // *** eShop *** //
        formVals['price_eshop'] = "{{ old('price_eshop') }}";
        formVals['players'] = "{{ old('players') }}";
        // *** Additional *** //
        formVals['developer'] = "{{ old('developer')|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        formVals['publisher'] = "{{ old('publisher')|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        formVals['amazon_uk_link'] = "{{ old('amazon_uk_link') }}";
        formVals['overview'] = "{{ old('overview')|replace({'\"': '\\"', '&quot;': '\\"'})|raw }}";
        // *** Media *** //
        formVals['media_folder'] = "{{ old('media_folder') }}";
        formVals['video_url'] = "{{ old('video_url') }}";
        formVals['boxart_square_url'] = "{{ old('boxart_square_url') }}";
        formVals['vendor_page_url'] = "{{ old('vendor_page_url') }}";
        formVals['nintendo_page_url'] = "{{ old('nintendo_page_url') }}";
        formVals['twitter_id'] = "{{ old('twitter_id') }}";
        formVals['eshop_europe_fs_id'] = "{{ old('eshop_europe_fs_id') }}";

    }

    // Enable tabs
    $('#tabs').tabs();

    // *** Main *** //
    $('#title').val(formVals['title']);
    $('#link_title').val(formVals['link_title']);
    // *** Dates *** //
    {% for key,value in RegionList %}
    $('#release_date_{{ key }}').val(formVals['release_date_{{ key }}']);
    $('#upcoming_date_{{ key }}').val(formVals['upcoming_date_{{ key }}']);
    if (formVals['is_released_{{ key }}'] == 1) {
        $('#is_released_{{ key }}').attr('checked', true);
    }
    {% endfor %}
    // *** eShop *** //
    $('#price_eshop').val(formVals['price_eshop']);
    $('#players').val(formVals['players']);
    // *** Additional *** //
    $('#developer').val(formVals['developer']);
    $('#publisher').val(formVals['publisher']);
    $('#amazon_uk_link').val(formVals['amazon_uk_link']);
    $('#overview').val(formVals['overview']);
    // *** Media *** //
    $('#media_folder').val(formVals['media_folder']);
    $('#video_url').val(formVals['video_url']);
    $('#boxart_square_url').val(formVals['boxart_square_url']);
    $('#vendor_page_url').val(formVals['vendor_page_url']);
    $('#nintendo_page_url').val(formVals['nintendo_page_url']);
    $('#twitter_id').val(formVals['twitter_id']);
    $('#eshop_europe_fs_id').val(formVals['eshop_europe_fs_id']);

    // *** Genres *** //
    {% if GameGenreList %}
    {% for item in GameGenreList %}
        $('#genre_item_{{ item.genre_id }}').attr('checked', true);
    {% endfor %}
    {% endif %}

    $('#eshop_europe_fs_id').select2();

    // Autogenerate link URL
    $('#title').on('blur', function() {
        if ($('#link_title').val() != '') {
            return false;
        }
        gameTitle = $(this).val();
        if (gameTitle == '') {
            $('#link_title').val('');
            return false;
        }

        $.getJSON('/api/url/link-text', {title: gameTitle}, function(data) {
            linkText = data.linkText;
            //console.log(linkText);
            $('#link_title').val(linkText);
        });
    });

    // Autogenerate upcoming date
    $('#release_date_eu, #release_date_us, #release_date_jp').on('blur', function() {

        fieldId = $(this).attr('id');
        fieldRegion = fieldId.replace('release_date_', '');

        releaseDate = $(this).val();

        if (releaseDate == '') {
            $('#upcoming_date_' + fieldRegion).val('');
            return false;
        }

        //var upcomingDate = releaseDate.split("-").reverse().join("-");

        // can keep the same value as the field rather helpfully translates the value
        $('#upcoming_date_' + fieldRegion).val(releaseDate);
    });

    // Save, return to list
    $('#btn-submit').on('click', function() {
        $('#btn-submit').click();
    });

    // Save, go to next
    $('#btn-save-go-to-next').on('click', function() {
        nextId = '{{ GameListFilterNextId }}';
        if (nextId != '') {
            $('#button_pressed').val("save-go-to-next");
            $('#nav_next_id').val(nextId);
            $('#btn-submit').click();
        }
    });
    // Skip
    $('#btn-skip-go-to-next').on('click', function() {
        $('#button_pressed').val("skip-go-to-next");
        nextPageUrl = '/admin/games/edit/{{ GameListFilterNextId }}?filter={{ GameListFilter }}';
        //console.log(nextPageUrl);
        top.location.href = nextPageUrl;
        return false;
    });

</script>
