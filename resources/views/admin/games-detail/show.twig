{% extends 'theme/wos/admin/clean-wide.twig' %}

{% set crumbNav = [{'url': route('admin.games.list'), 'text': 'Games'}, {'text': PageTitle}] %}

{% block page_inner %}

{% if LastAction == 'add' and LastGame is not null %}
    <div class="alert alert-warning" role="alert">
        Successfully added <strong>{{ LastGame.title }}</strong>.
    </div>
{% elseif LastAction == 'edit' and LastGame is not null %}
    <div class="alert alert-warning" role="alert">
        Successfully edited <strong>{{ LastGame.title }}</strong>.
    </div>
{% endif %}

<div id="js-admin-notify" class="alert alert-success" role="alert" style="display: none;"></div>

<div class="row">

    <div class="col-md-4">

        <a href="{{ route('admin.games.edit', {'gameId': GameId}) }}" class="btn btn-primary btn-md">Edit game</a>
        <a href="{{ LinkHelper.gameShow(GameData) }}" class="btn btn-primary btn-md" target="_blank">View game page</a>

    </div>

    <div class="col-md-4">

        {% if GameData.eshop_europe_fs_id is not null %}
            {% if GameData.eshopEuropeGame.fs_id is not null %}
                <a id="btn-update-eu-eshop-data" class="btn btn-primary btn-md" target="_blank">Update eShop data (EU)</a>
                <a id="btn-redownload-packshots" class="btn btn-primary btn-md" target="_blank">Update packshots</a>
            {% endif %}
        {% endif %}

    </div>

    <div class="col-md-4">

        <span class="pull-right">
            <a href="{{ route('admin.games.delete', {'gameId': GameId}) }}" class="btn btn-danger btn-md">Delete game</a>
        </span>

    </div>

</div>

<div class="row">

    <div class="col-md-4">

        <h2>General info</h2>
        <table class="table table-condensed table-responsive">
            <tr>
                <td style="width: 150px;">
                    <span style="font-weight: bold;">Players</span>
                </td>
                <td>{{ GameData.players }}</td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Reviews</span>
                </td>
                <td>
                    {{ GameData.review_count }}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Average rating</span>
                </td>
                <td>
                    {{ GameData.rating_avg }}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Rank</span>
                </td>
                <td>
                    {{ GameData.game_rank }}
                </td>
            </tr>

            <tr>
                <td>
                    <strong>Video URL</strong>
                </td>
                <td class="text-left">
                    {% if GameData.video_url != '' %}
                        <em>OK</em>
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('admin.games-title-hash.list', {'gameId': GameId}) }}"><strong>Hashes</strong></a>
                </td>
                <td class="text-left">
                    {% if GameData.titleHashes.count > 0 %}
                        <em>OK</em>
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

        </table>

    </div>

    <div class="col-md-4">

        <h2>Categorisation</h2>

        <table class="table table-condensed table-responsive">

            <tr>
                <td>
                    <span style="font-weight: bold;">Primary type</span>
                </td>
                <td>
                    {% if GameData.primary_type_id %}
                        <a href="{{ route('games.browse.byPrimaryType.page', {'primaryType': GameData.primaryType.link_title}) }}" target="_blank">{{ GameData.primaryType.primary_type }}</a>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Series</span>
                </td>
                <td>
                    {% if GameData.series_id %}
                        <a href="{{ route('games.browse.bySeries.page', {'primaryType': GameData.series.link_title}) }}" target="_blank">{{ GameData.series.series }}</a>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('staff.categorisation.tag.game.list', {'gameId': GameId}) }}"><strong>Tags</strong></a>
                </td>
                <td>
                    {% if GameTags|length > 0 %}
                        {% for item in GameTags %}
                            <a href="{{ route('games.browse.byTag.page', {'tag': item.tag.link_title}) }}" target="_blank">
                                <nobr>{{ item.tag.tag_name }}</nobr>
                            </a>
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Genres</span>
                </td>
                <td>
                    {% if GameGenres|length > 0 %}
                        {% for item in GameGenres %}
                            <nobr>{{ item.genre.genre }}</nobr>
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('admin.game.partner.list', {'gameId': GameId}) }}"><strong>Developers</strong></a>
                </td>
                <td>
                    {% if GameDevelopers|length > 0 %}
                        {% for item in GameDevelopers %}
                            <a href="{{ route('partners.detail.games-company', {'linkTitle': item.developer.link_title}) }}" target="_blank">{{ item.developer.name }}</a>
                            <br>
                        {% endfor %}
                    {% else %}
                        {{ GameData.developer }}
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('admin.game.partner.list', {'gameId': GameId}) }}"><strong>Publishers</strong></a>
                </td>
                <td>
                    {% if GamePublishers|length > 0 %}
                        {% for item in GamePublishers %}
                            <a href="{{ route('partners.detail.games-company', {'linkTitle': item.publisher.link_title}) }}" target="_blank">{{ item.publisher.name }}</a>
                            <br>
                        {% endfor %}
                    {% else %}
                        {{ GameData.publisher }}
                    {% endif %}
                </td>
            </tr>

        </table>

    </div>

    <div class="col-md-4">

        <h2>External</h2>
        <table class="table table-condensed table-responsive">
            <tr>
                <td style="width: 150px;">
                    <span style="font-weight: bold;">eShop Europe link</span>
                </td>
                <td>
                    {% if GameData.eshop_europe_fs_id is not null %}
                        {% if GameData.eshopEuropeGame.fs_id is not null %}
                            <a href="{{ route('admin.feed-items.eshop.europe.view', {'itemId': GameData.eshop_europe_fs_id}) }}">
                                <i class="fas fa-link"></i>
                            </a> - <em>linked</em>
                        {% else %}
                            <i class="fas fa-unlink"></i> - <em>broken link</em>
                        {% endif %}
                    {% else %}
                        <em>Not linked</em>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td style="width: 150px;">
                    <span style="font-weight: bold;">eShop price</span>
                </td>
                <td>
                    {% if GameData.price_eshop %}
                        {% if GameData.eshopEuropeGame.fs_id is null %}
                            <span class="h4" style="font-weight: bold;">&pound;{{ GameData.price_eshop }}</span>
                        {% elseif GameData.eshopEuropeGame.price_discount_percentage_f == '0.00' %}
                            <span class="h4" style="font-weight: bold;">&pound;{{ GameData.price_eshop }}</span>
                        {% else %}
                            <s><span class="h4">&pound;{{ GameData.price_eshop }}</span></s>
                            &nbsp;&nbsp;&nbsp;
                            <span class="h4" style="font-weight: bold;">&pound;{{ GameData.eshopEuropeGame.price_lowest_f }}</span>
                            &nbsp;&nbsp;&nbsp;
                            <span style="color: #f00;">{{ GameData.eshopEuropeGame.price_discount_percentage_f }}% off</span>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% if ReleaseDates %}
                {% for item in ReleaseDates %}
                    {% if item.region == 'eu' %}
                        {% set RegionDesc = 'Europe' %}
                    {% elseif item.region == 'us' %}
                        {% set RegionDesc = 'US' %}
                    {% elseif item.region == 'jp' %}
                        {% set RegionDesc = 'Japan' %}
                    {% else %}
                        {% set RegionDesc = item.region %}
                    {% endif %}
                    <tr>
                        <td>
                            <span style="font-weight: bold;">{{ RegionDesc }} release</span>
                        </td>
                        <td>
                            {% if item.release_date and item.is_released == 1 %}
                                {{ item.release_date|date('jS M Y') }}
                            {% else %}
                                {{ item.upcoming_date }}
                            {% endif %}
                            {% if item.is_locked == 1 %}
                                <i class="fas fa-lock"></i>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            {% endif %}
            {% if GameData.eshopEuropeGame.fs_id is not null %}
                <tr>
                    <td>
                        <span style="font-weight: bold;">Link to eShop</span>
                    </td>
                    <td>
                        <a href="{{ LinkHelper.eshopUrl('eu', GameData.eshopEuropeGame.url) }}" target="_blank">Visit eShop page</a>
                    </td>
                </tr>
            {% endif %}
            {% if GameData.amazon_uk_link %}
                <tr>
                    <td>
                        <span style="font-weight: bold;">Buy link</span>
                    </td>
                    <td>
                        <a href="{{ GameData.amazon_uk_link }}" target="_blank">Amazon UK</a>
                    </td>
                </tr>
            {% endif %}
        </table>

    </div>

</div>

<div class="row">

    <div class="col-md-12">

        {% if GameChangeHistory|length %}
        <h2>
            Change history <span class="h4">(<a href="{{ route('admin.game-change-history.index') }}?gameId={{ GameId }}">view all</a>)</span>
        </h2>
        <table class="table table-condensed table-responsive">
            <tr>
            <tr>
                <th class="text-right">#</th>
                <th>Game</th>
                <th>Table</th>
                <th class="text-center">Source</th>
                <th class="text-center">Change type</th>
                <th class="text-center">Date</th>
                <th>Changes</th>
            </tr>
            </tr>
            {% for item in GameChangeHistory %}
                <tr>
                    <td class="text-right">
                        {{ item.id }}
                    </td>
                    <td>
                        {% if item.game %}
                            <a href="{{ LinkHelper.gameShow(item.game) }}" target="_blank">{{ item.game.title }}</a>
                        {% else %}
                            {{ item.game_id }}
                        {% endif %}
                    </td>
                    <td>
                        {{ item.affected_table_name }}
                    </td>
                    <td class="text-center">
                        {{ item.source }}
                    </td>
                    <td class="text-center">
                        {{ item.change_type }}
                    </td>
                    <td class="text-center">
                        <small>{{ item.created_at|date('Y-m-d H:i') }}</small>
                    </td>
                    <td>
                        {% if item.data_changed %}
                            {% set dataChanged = JsonHelper.jsonDecode(item.data_changed) %}
                            <p>
                                <small>
                                    {% for field,value in dataChanged %}
                                        {{ field }}: {{ value }}<br>
                                    {% endfor %}
                                </small>
                            </p>
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </table>
        {% endif %}

    </div>

</div>

<script>

    var gameId = '{{ GameId }}';

    $('#btn-update-eu-eshop-data').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('Update the eShop data for this game?')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('admin.games.updateEshopData') }}', {'gameId': gameId, 'regionCode': 'eu'}, function(data) {
            $('#js-admin-notify').text('Updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 2000);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#btn-redownload-packshots').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('Update the packshots for this game?')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('admin.games.redownloadPackshots') }}', {'gameId': gameId, 'regionCode': 'eu'}, function(data) {
            $('#js-admin-notify').text('Updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 2000);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

</script>

{% endblock page_inner %}
