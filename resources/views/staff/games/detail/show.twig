{% extends 'theme/wos/staff/clean-wide.twig' %}

{% set crumbNav = [{'url': route('staff.games.dashboard'), 'text': 'Games'}, {'text': PageTitle}] %}

{% block page_inner %}

{% if LastAction == 'add' and LastGame is not null %}
    <div class="alert alert-warning" role="alert">
        Successfully added <strong>{{ LastGame.title }}</strong>.
    </div>
{% elseif LastAction == 'edit' and LastGame is not null %}
    <div class="alert alert-warning" role="alert">
        Successfully edited <strong>{{ LastGame.title }}</strong>.
    </div>
{% endif %}

<div id="js-admin-notify" class="alert alert-success" role="alert" style="display: none;"></div>

<div class="row">

    <div class="col-md-4">

        <a href="{{ route('admin.games.edit', {'gameId': GameId}) }}" class="btn btn-primary btn-md">Edit game</a>
        <a href="{{ LinkHelper.gameShow(GameData) }}" class="btn btn-primary btn-md" target="_blank">View game page</a>

    </div>

    <div class="col-md-4">

        {% if GameData.eshop_europe_fs_id is not null %}
            {% if GameData.eshopEuropeGame.fs_id is not null %}
                <a id="btn-update-eu-eshop-data" class="btn btn-primary btn-md" target="_blank">Update eShop data (EU)</a>
                <a id="btn-redownload-packshots" class="btn btn-primary btn-md" target="_blank">Update packshots</a>
            {% endif %}
        {% endif %}

    </div>

    <div class="col-md-4">

        <span class="pull-right">
            <a href="{{ route('admin.games.delete', {'gameId': GameId}) }}" class="btn btn-danger btn-md">Delete game</a>
        </span>

    </div>

</div>

<div class="row">

    <div class="col-md-4">

        <h2>General info</h2>
        <table class="table table-condensed table-responsive">
            <tr>
                <td style="width: 150px;">
                    <span style="font-weight: bold;">Players</span>
                </td>
                <td>{{ GameData.players }}</td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Reviews</span>
                </td>
                <td>
                    {{ GameData.review_count }}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Average rating</span>
                </td>
                <td>
                    {{ GameData.rating_avg }}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Rank</span>
                </td>
                <td>
                    {{ GameData.game_rank }}
                </td>
            </tr>

            <tr>
                <td>
                    <strong>Video URL</strong>
                </td>
                <td class="text-left">
                    {% if GameData.video_url != '' %}
                        <em>OK</em>
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('admin.games-title-hash.list', {'gameId': GameId}) }}"><strong>Hashes</strong></a>
                </td>
                <td class="text-left">
                    {% if GameData.titleHashes.count > 0 %}
                        <em>OK</em>
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

        </table>

    </div>

    <div class="col-md-4">

        <h2>Categorisation</h2>

        <table class="table table-condensed table-responsive">

            <tr>
                <td>
                    <span style="font-weight: bold;">Primary type</span>
                </td>
                <td>
                    {% if GameData.primary_type_id %}
                        <a href="{{ route('games.browse.byPrimaryType.page', {'primaryType': GameData.primaryType.link_title}) }}" target="_blank">{{ GameData.primaryType.primary_type }}</a>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Series</span>
                </td>
                <td>
                    {% if GameData.series_id %}
                        <a href="{{ route('games.browse.bySeries.page', {'primaryType': GameData.series.link_title}) }}" target="_blank">{{ GameData.series.series }}</a>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('staff.categorisation.tag.game.list', {'gameId': GameId}) }}"><strong>Tags</strong></a>
                </td>
                <td>
                    {% if GameTags|length > 0 %}
                        {% for item in GameTags %}
                            <a href="{{ route('games.browse.byTag.page', {'tag': item.tag.link_title}) }}" target="_blank">
                                <nobr>{{ item.tag.tag_name }}</nobr>
                            </a>
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <span style="font-weight: bold;">Genres</span>
                </td>
                <td>
                    {% if GameGenres|length > 0 %}
                        {% for item in GameGenres %}
                            <nobr>{{ item.genre.genre }}</nobr>
                            {% if not loop.last %}, {% endif %}
                        {% endfor %}
                    {% else %}
                        <em>None set.</em>
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('admin.game.partner.list', {'gameId': GameId}) }}"><strong>Developers</strong></a>
                </td>
                <td>
                    {% if GameDevelopers|length > 0 %}
                        {% for item in GameDevelopers %}
                            <a href="{{ route('partners.detail.games-company', {'linkTitle': item.developer.link_title}) }}" target="_blank">{{ item.developer.name }}</a>
                            <br>
                        {% endfor %}
                    {% else %}
                        {{ GameData.developer }}
                    {% endif %}
                </td>
            </tr>

            <tr>
                <td>
                    <a href="{{ route('admin.game.partner.list', {'gameId': GameId}) }}"><strong>Publishers</strong></a>
                </td>
                <td>
                    {% if GamePublishers|length > 0 %}
                        {% for item in GamePublishers %}
                            <a href="{{ route('partners.detail.games-company', {'linkTitle': item.publisher.link_title}) }}" target="_blank">{{ item.publisher.name }}</a>
                            <br>
                        {% endfor %}
                    {% else %}
                        {{ GameData.publisher }}
                    {% endif %}
                </td>
            </tr>

        </table>

    </div>

    <div class="col-md-4">

        <h2>External</h2>
        <table class="table table-condensed table-responsive">
            <tr>
                <td style="width: 150px;">
                    <span style="font-weight: bold;">eShop Europe link</span>
                </td>
                <td>
                    {% if GameData.eshop_europe_fs_id is not null %}
                        {% if GameData.eshopEuropeGame.fs_id is not null %}
                            <a href="{{ route('admin.feed-items.eshop.europe.view', {'itemId': GameData.eshop_europe_fs_id}) }}">
                                <i class="fas fa-link"></i>
                            </a> - <em>linked</em>
                        {% else %}
                            <i class="fas fa-unlink"></i> - <em>broken link</em>
                        {% endif %}
                    {% else %}
                        <em>Not linked</em>
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td style="width: 150px;">
                    <span style="font-weight: bold;">eShop price</span>
                </td>
                <td>
                    {% if GameData.price_eshop %}
                        {% if GameData.eshopEuropeGame.fs_id is null %}
                            <span class="h4" style="font-weight: bold;">&pound;{{ GameData.price_eshop }}</span>
                        {% elseif GameData.eshopEuropeGame.price_discount_percentage_f == '0.00' %}
                            <span class="h4" style="font-weight: bold;">&pound;{{ GameData.price_eshop }}</span>
                        {% else %}
                            <s><span class="h4">&pound;{{ GameData.price_eshop }}</span></s>
                            &nbsp;&nbsp;&nbsp;
                            <span class="h4" style="font-weight: bold;">&pound;{{ GameData.eshopEuropeGame.price_lowest_f }}</span>
                            &nbsp;&nbsp;&nbsp;
                            <span style="color: #f00;">{{ GameData.eshopEuropeGame.price_discount_percentage_f }}% off</span>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: bold;">Europe release</span>
                </td>
                <td>
                    {% if GameData.eu_release_date %}
                        {{ GameData.eu_release_date|date('jS M Y') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: bold;">US release</span>
                </td>
                <td>
                    {% if GameData.us_release_date %}
                        {{ GameData.us_release_date|date('jS M Y') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: bold;">Japan release</span>
                </td>
                <td>
                    {% if GameData.jp_release_date %}
                        {{ GameData.jp_release_date|date('jS M Y') }}
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td>
                    <span style="font-weight: bold;">Released (in EU)?</span>
                </td>
                <td>
                    {% if GameData.eu_is_released == 1 %}
                        Yes
                    {% else %}
                        No
                    {% endif %}
                </td>
            </tr>
            {% if GameData.eshopEuropeGame.fs_id is not null %}
                <tr>
                    <td>
                        <span style="font-weight: bold;">Link to eShop</span>
                    </td>
                    <td>
                        <a href="{{ LinkHelper.eshopUrl('eu', GameData.eshopEuropeGame.url) }}" target="_blank">Visit eShop page</a>
                    </td>
                </tr>
            {% endif %}
            {% if GameData.amazon_uk_link %}
                <tr>
                    <td>
                        <span style="font-weight: bold;">Buy link</span>
                    </td>
                    <td>
                        <a href="{{ GameData.amazon_uk_link }}" target="_blank">Amazon UK</a>
                    </td>
                </tr>
            {% endif %}
        </table>

    </div>

</div>

<div class="row">

    <div class="col-md-12">

        <div id="tabs">

            <ul>
                <li><a href="#tabs-import-rules">Import rules</a></li>
                <li><a href="#tabs-audit">Audit</a></li>
                <li><a href="#tabs-reviews">Reviews</a></li>
                <li><a href="#tabs-title-hashes">Title hashes</a></li>
            </ul>

            <div id="tabs-import-rules">

                <div class="row">

                    <div class="col-md-6">

                        <h2>Import rules: eShop</h2>

                        {% if ImportRulesEshop %}
                            <a class="btn btn-primary btn-sm" style="color: #fff;" href="{{ route('staff.games.import-rule-eshop.edit', {'gameId': GameId}) }}">Edit rules</a>
                            <br><br>
                            <table class="table table-condensed table-responsive">
                                <tbody>
                                <tr>
                                    <td>
                                        Ignore publishers
                                    </td>
                                    <td>
                                        {% if ImportRulesEshop.shouldIgnorePublishers() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore Europe dates
                                    </td>
                                    <td>
                                        {% if ImportRulesEshop.shouldIgnoreEuropeDates() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore price
                                    </td>
                                    <td>
                                        {% if ImportRulesEshop.shouldIgnorePrice() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore players
                                    </td>
                                    <td>
                                        {% if ImportRulesEshop.shouldIgnorePlayers() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore genres
                                    </td>
                                    <td>
                                        {% if ImportRulesEshop.shouldIgnoreGenres() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        {% else %}
                            No eShop rules found.
                            <br><br>
                            <a class="btn btn-primary btn-sm" style="color: #fff;" href="{{ route('staff.games.import-rule-eshop.edit', {'gameId': GameId}) }}">Add rules</a>
                        {% endif %}

                    </div>

                    <div class="col-md-6">

                        <h2>Import rules: Wikipedia</h2>

                        {% if ImportRulesWikipedia %}
                            <a class="btn btn-primary btn-sm" style="color: #fff;" href="{{ route('staff.games.import-rule-wikipedia.edit', {'gameId': GameId}) }}">Edit rules</a>
                            <br><br>
                            <table class="table table-condensed table-responsive">
                                <tbody>
                                <tr>
                                    <td>
                                        Ignore developers
                                    </td>
                                    <td>
                                        {% if ImportRulesWikipedia.shouldIgnoreDevelopers() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore publishers
                                    </td>
                                    <td>
                                        {% if ImportRulesWikipedia.shouldIgnorePublishers() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore Europe dates
                                    </td>
                                    <td>
                                        {% if ImportRulesWikipedia.shouldIgnoreEuropeDates() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore US dates
                                    </td>
                                    <td>
                                        {% if ImportRulesWikipedia.shouldIgnoreUSDates() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        Ignore JP dates
                                    </td>
                                    <td>
                                        {% if ImportRulesWikipedia.shouldIgnoreJPDates() %}
                                            Yes
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        {% else %}
                            No Wikipedia rules found.
                            <br><br>
                            <a class="btn btn-primary btn-sm" style="color: #fff;" href="{{ route('staff.games.import-rule-wikipedia.edit', {'gameId': GameId}) }}">Add rules</a>
                        {% endif %}

                    </div>

                </div>

            </div>

            <div id="tabs-audit">

                <h2>Audit</h2>

                {% if GameAuditsCore|length %}
                    <table class="table table-condensed table-responsive">
                        <thead>
                        <tr>
                            <th class="text-right">#</th>
                            <th>Type</th>
                            <th>Old values</th>
                            <th>New values</th>
                            <th class="text-center">Date</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for item in GameAuditsCore %}
                            <tr>
                                <td class="text-right">
                                    <p>
                                        <small>
                                            {{ item.id }}
                                        </small>
                                    </p>
                                </td>
                                <td>
                                    <p>
                                        <small>
                                            {{ item.auditable_type }}
                                        </small>
                                    </p>
                                </td>
                                <td>
                                    {% if item.old_values %}
                                        <p>
                                            <small>
                                            {% for vf, vv in item.old_values %}
                                                {{ vf }}: {{ vv }}<br>
                                            {% endfor %}
                                            </small>
                                        </p>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.new_values %}
                                        <p>
                                            <small>
                                                {% for vf, vv in item.new_values %}
                                                    {{ vf }}: {{ vv }}<br>
                                                {% endfor %}
                                            </small>
                                        </p>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <small>{{ item.created_at|date('Y-m-d H:i') }}</small>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% endif %}

            </div>

            <div id="tabs-reviews">

                <h2>Reviews</h2>
                {% include 'staff/reviews/review-link-table.twig' with {'ReviewLinks': GameReviews} %}

            </div>

            <div id="tabs-title-hashes">

                <h2>Title hashes</h2>
                {% include 'staff/games/title-hash/table.twig' with {'TitleHashList': GameTitleHashes} %}

            </div>

        </div>

    </div>

</div>

<div class="row">

    <div class="col-md-12">

        <hr>

    </div>

</div>

<script>

    var gameId = '{{ GameId }}';

    $('#tabs').tabs();

    var tabId = '{{ SelectedTabId }}';
    if (tabId == 'reviews') {
        $("#tabs").tabs("option", "active", 2);
    } else if (tabId == 'title-hashes') {
        $("#tabs").tabs("option", "active", 3);
    }

    $('#btn-update-eu-eshop-data').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('Update the eShop data for this game?')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('admin.games.updateEshopData') }}', {'gameId': gameId}, function(data) {
            $('#js-admin-notify').text('Updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 2000);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#btn-redownload-packshots').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('Update the packshots for this game?')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('admin.games.redownloadPackshots') }}', {'gameId': gameId}, function(data) {
            $('#js-admin-notify').text('Updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 2000);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

</script>

{% endblock page_inner %}
