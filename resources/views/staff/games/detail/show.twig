{% extends 'theme/staff-b5/layout-default.twig' %}

{% import 'ui/components/gsc/insights-games-table.twig' as gscgames %}

{% block page_inner %}

{% if LastAction == 'add' and LastGame is not null %}
    <div class="alert alert-warning" role="alert">
        Successfully added <strong>{{ LastGame.title }}</strong>.
    </div>
{% elseif LastAction == 'edit' and LastGame is not null %}
    <div class="alert alert-warning" role="alert">
        Successfully edited <strong>{{ LastGame.title }}</strong>.
    </div>
{% endif %}
{% if PageAlert is not null and DSItem is not null %}
    <div class="alert alert-warning" role="alert">
        No matching publisher could be linked to this game. Please check for the publisher named
        <strong>{{ DSItem.publishers }}</strong> and add it if necessary.
    </div>
{% endif %}

<div id="js-admin-notify" class="alert alert-success" role="alert" style="display: none;"></div>

{% if ReleaseDateEUNintendoCoUkDifferenceCount > 0 %}
    <div class="alert alert-danger" role="alert">
        EU release date is different to the Nintendo.co.uk API.
        <a href="{{ route('staff.data-sources.differences.nintendo-co-uk.eu-release-date') }}?gameid={{ GameId }}">Review here</a>.
    </div>
{% endif %}
{% if PriceNintendoCoUkDifferenceCount > 0 %}
    <div class="alert alert-danger" role="alert">
        Price is different to the Nintendo.co.uk API.
        <a href="{{ route('staff.data-sources.differences.nintendo-co-uk.price') }}?gameid={{ GameId }}">Review here</a>.
    </div>
{% endif %}
{% if PlayersNintendoCoUkDifferenceCount > 0 %}
    <div class="alert alert-danger" role="alert">
        No of players is different to the Nintendo.co.uk API.
        <a href="{{ route('staff.data-sources.differences.nintendo-co-uk.players') }}?gameid={{ GameId }}">Review here</a>.
    </div>
{% endif %}

<div class="row">

    <div class="col-md-4">

        <a href="{{ route('staff.games.edit', {'gameId': GameId}) }}" class="btn btn-primary btn-sm">Edit game</a>
        <a href="{{ route('staff.games.editAffiliates', {'gameId': GameId}) }}" class="btn btn-primary btn-sm">Edit affiliates</a>
        <a href="{{ game_url(GameData) }}" class="btn btn-primary btn-sm" target="_blank">View game page</a>

    </div>

    <div class="col-md-4">

    </div>

    <div class="col-md-4">

    <span class="float-end">
        <a href="{{ route('staff.games.delete', {'gameId': GameId}) }}" class="btn btn-danger btn-sm">Delete game</a>
    </span>

    </div>

</div>

<br>

<div class="row">

    <div class="col-md-8">

        {% set boxartUrl = ImageHelper.imageHeaderUrl(GameData) %}
        {% if boxartUrl %}
            <img src="{{ boxartUrl }}" class="img-fluid" style="border: 0; width: 100%;" alt="{{ GameData.title }}">
        {% else %}
            <div style="background: #ccc; height: 300px; width: 100%;" class="img-fluid"></div>
        {% endif %}

    </div>

    <div class="col-md-4">

        <h5 class="hdr-block">Game status</h5>

        <div id="game-status-display" class="row" style="align-items:center; margin:2px 0;">
            <div class="col-md-5 col-sm-6 col-12" style="line-height:1.2;">
                <strong>Status</strong>
            </div>
            <div class="col-md-3 col-sm-3 col-6" style="line-height:1.2;">
                {% if GameData.game_status.value == 'active' %}
                    <span class="badge bg-success" style="display:inline-block; min-width:72px; text-align:center;">Active</span>
                {% elseif GameData.game_status.value == 'delisted' %}
                    <span class="badge bg-warning" style="display:inline-block; min-width:72px; text-align:center;">De-listed</span>
                {% elseif GameData.game_status.value == 'soft_deleted' %}
                    <span class="badge bg-danger" style="display:inline-block; min-width:72px; text-align:center;">Soft deleted</span>
                {% else %}
                    <span class="badge bg-secondary" style="display:inline-block; min-width:72px; text-align:center;">Unknown</span>
                {% endif %}
            </div>
            <div class="col-md-4 col-sm-3 col-6" style="line-height:1.2;">
                <a href="#" id="game-status-edit-btn" class="btn btn-sm btn-outline-secondary" style="margin-left:6px;">Edit</a>
            </div>
        </div>
        <div id="game-status-edit" class="row" style="align-items:center; margin:2px 0; display:none;">
            <div class="col-md-5 col-sm-6 col-12" style="line-height:1.2;">
                <strong>Status</strong>
            </div>
            <div class="col-md-7 col-sm-6 col-12" style="line-height:1.2;">
                <select id="game-status-dropdown" class="form-select form-select-sm" style="width: auto; display: inline-block;">
                    <option value="active" {% if GameData.game_status.value == 'active' %}selected{% endif %}>Active</option>
                    <option value="delisted" {% if GameData.game_status.value == 'delisted' %}selected{% endif %}>De-listed</option>
                    <option value="soft_deleted" {% if GameData.game_status.value == 'soft_deleted' %}selected{% endif %}>Soft deleted</option>
                </select>
                <a href="#" id="game-status-save-btn" class="btn btn-sm btn-primary ms-2">Save</a>
                <a href="#" id="game-status-cancel-btn" class="btn btn-sm btn-outline-secondary ms-1">Cancel</a>
            </div>
        </div>
        <hr style="margin:6px 0;">

        <h5 class="hdr-block">Data checks</h5>
        {% include 'ui/components/game/checks.twig' with {'checks': Checks} %}

    </div>

</div>

<br>

<div class="row">

    <div class="col-md-4">

        {% include 'staff/games/detail/detail-col1.twig' %}

    </div>

    <div class="col-md-4">

        {% include 'staff/games/detail/detail-col2.twig' %}

    </div>

    <div class="col-md-4">

        {% include 'staff/games/detail/detail-col3.twig' %}

    </div>

</div>

<div class="row">

    <div class="col-md-12">

        <div id="tabs">

            <ul>
                <li><a href="#tabs-gsc-snapshot">GSC snapshot</a></li>
                <li><a href="#tabs-data-sources">Data sources</a></li>
                <li><a href="#tabs-import-rules">Import rules</a></li>
                <li><a href="#tabs-audit">Audit</a></li>
                <li><a href="#tabs-crawl-lifecycle">Crawl lifecycle</a></li>
                <li><a href="#tabs-reviews">Reviews</a></li>
                <li><a href="#tabs-title-hashes">Title hashes</a></li>
            </ul>

            <div id="tabs-gsc-snapshot">

                <h2>GSC snapshot</h2>

                {{ gscgames.insightsTable(GscSnapshotData, {view: 'game-detail'}) }}

            </div>

            <div id="tabs-data-sources">

                <h2>Data sources</h2>
                {% include 'staff/games/detail/data-sources.twig' %}

            </div>

            <div id="tabs-import-rules">

                <div class="row">

                    <div class="col-md-6">

                        <h2>Import rules: eShop</h2>
                        {% include 'staff/games/detail/tab-import-rules-eshop.twig' %}

                    </div>

                    <div class="col-md-6">

                    </div>

                </div>

            </div>

            <div id="tabs-audit">

                <h2>Audit</h2>
                {% include 'staff/games/detail/tab-audit.twig' %}

            </div>

            <div id="tabs-crawl-lifecycle">

                <h2>Crawl lifecycle</h2>

                <p>
                    <strong>Last crawled:</strong>
                    {% if GameData.last_crawled_at %}
                        {{ GameData.last_crawled_at|date('Y-m-d H:i:s') }}
                    {% else %}
                        Never
                    {% endif %}
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    <strong>Last status:</strong>
                    {% if GameData.last_crawl_status %}
                        {{ GameData.last_crawl_status }}
                        {% if GameData.last_crawl_status == 200 %}
                            <span class="badge bg-success">OK</span>
                        {% elseif GameData.last_crawl_status == 404 %}
                            <span class="badge bg-danger">Not Found</span>
                        {% elseif GameData.last_crawl_status == 410 %}
                            <span class="badge bg-danger">Gone</span>
                        {% elseif GameData.last_crawl_status >= 300 and GameData.last_crawl_status < 400 %}
                            <span class="badge bg-warning">Redirect</span>
                        {% elseif GameData.last_crawl_status >= 500 %}
                            <span class="badge bg-danger">Server Error</span>
                        {% endif %}
                    {% else %}
                        -
                    {% endif %}
                    &nbsp;&nbsp;|&nbsp;&nbsp;
                    <strong>Priority:</strong>
                    {% if GameData.crawl_priority %}
                        <span class="badge bg-info">Queued</span>
                    {% else %}
                        <a href="#" id="queue-crawl-btn" class="btn btn-sm btn-outline-primary">Queue for crawl</a>
                    {% endif %}
                </p>

                {% if CrawlLifecycle|length > 0 %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Status</th>
                            <th>URL</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in CrawlLifecycle %}
                        <tr>
                            <td>{{ item.crawled_at|date('Y-m-d H:i:s') }}</td>
                            <td>
                                {{ item.status_code }}
                                {% if item.status_code == 200 %}
                                    <span class="badge bg-success">Recovered</span>
                                {% elseif item.status_code == 404 %}
                                    <span class="badge bg-danger">Not Found</span>
                                {% elseif item.status_code == 410 %}
                                    <span class="badge bg-danger">Gone</span>
                                {% elseif item.status_code >= 300 and item.status_code < 400 %}
                                    <span class="badge bg-warning">Redirect</span>
                                {% elseif item.status_code >= 500 %}
                                    <span class="badge bg-danger">Server Error</span>
                                {% endif %}
                            </td>
                            <td style="font-size: 0.85em; word-break: break-all;">{{ item.url_crawled }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted">No lifecycle events recorded yet. Events are logged when crawl status changes (problems detected or resolved).</p>
                {% endif %}

            </div>

            <div id="tabs-reviews">

                <h2>Reviews</h2>
                {% include 'staff/reviews/review-link-table.twig' with {'ReviewLinks': GameReviews} %}

            </div>

            <div id="tabs-title-hashes">

                <h2>Title hashes</h2>
                {% include 'staff/games/title-hash/table.twig' with {'TitleHashList': GameTitleHashes} %}

            </div>

        </div>

    </div>

</div>

<div class="row">

    <div class="col-md-12">

        <hr>

    </div>

</div>

<script>

    var gameId = '{{ GameId }}';

    $('#tabs').tabs();

    var tabId = '{{ SelectedTabId }}';
    if (tabId == 'reviews') {
        $("#tabs").tabs("option", "active", 4);
    } else if (tabId == 'title-hashes') {
        $("#tabs").tabs("option", "active", 5);
    }

    $('#btn-update-eu-eshop-data').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('Update the eShop data for this game?')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('staff.games.detail.updateEshopData', {'gameId': GameId}) }}', {}, function(data) {
            $('#js-admin-notify').text('Updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 2000);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#btn-redownload-packshots').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('Update the packshots for this game?')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('staff.games.detail.redownloadPackshots', {'gameId': GameId}) }}', {}, function(data) {
            $('#js-admin-notify').text('Updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 2000);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#game-status-edit-btn').on('click', function(e) {
        e.preventDefault();
        $('#game-status-display').hide();
        $('#game-status-edit').css('display', 'flex');
    });

    $('#game-status-cancel-btn').on('click', function(e) {
        e.preventDefault();
        $('#game-status-edit').hide();
        $('#game-status-display').css('display', 'flex');
    });

    $('#game-status-save-btn').on('click', function(e) {
        e.preventDefault();
        var newStatus = $('#game-status-dropdown').val();

        $('#js-admin-notify').hide();

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.post('{{ route('staff.games.detail.updateStatus', {'gameId': GameId}) }}', {status: newStatus}, function(data) {
            $('#js-admin-notify').text('Status updated!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 1500);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#queue-crawl-btn').on('click', function(e) {
        e.preventDefault();

        $('#js-admin-notify').hide();

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.post('{{ route('staff.games.detail.queueCrawl', {'gameId': GameId}) }}', {}, function(data) {
            $('#js-admin-notify').text('Queued for priority crawl!');
            $('#js-admin-notify').show();
            setTimeout("$('#js-admin-notify').fadeOut(); window.location.reload(true);", 1500);
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

</script>

{% endblock page_inner %}
