{% extends 'theme/wos/staff/clean-wide.twig' %}

{% set crumbNav = [
    {'url': route('staff.stats.dashboard'), 'text': 'Stats dashboard'},
    {'url': route('staff.stats.gamesCompany.oldPublisherByCount'), 'text': 'Old publishers - by count (All)'},
    {'text': PageTitle}] %}

{% block page_inner %}

<div class="row">

    <div class="col-md-12">

        {% if PublisherData is not defined %}
            <div class="alert alert-warning" role="alert">
                There isn't a record in the publisher list for <strong>{{ PublisherName }}</strong>.
                <a href="{{ route('admin.partners.games-company.add') }}">Add one now</a>.
            </div>
        {% else %}
            <input type="button" id="js-btn-add-all-new" class="btn btn-default" value="Add new pub to all">
            <input type="button" id="js-btn-remove-all-old" class="btn btn-default" value="Clear old pub from all">
        {% endif %}

        <div id="js-admin-notify" class="alert alert-success" role="alert" style="display: none;"></div>

        {% if ItemList %}

            <table id="table-publisher-list" class="table">
                <thead>
                    <tr>
                        <th class="text-center">#</th>
                        <th class="text-left">Title</th>
                        <th class="text-left">Publisher (old)</th>
                        <th class="text-left">Publisher (new)</th>
                        <th class="text-center">Options</th>
                        <th class="text-center">Finalise</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in ItemList %}
                    <tr>
                        <td class="text-center">
                            {{ item.id }}
                        </td>
                        <td class="text-left">
                            {{ item.title }}
                        </td>
                        <td class="text-left">
                            {{ item.publisher }}
                        </td>
                        <td class="text-left">
                            {{ item.gamePublishers.length }}
                            {% if item.gamePublishers is defined %}
                                {% for gamePub in item.gamePublishers %}
                                    {{ gamePub.publisher.name }}<br>
                                {% endfor %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{{ route('admin.games.edit', {'gameId': item.id}) }}">Edit game</a> :
                            <a href="{{ route('admin.game.partner.list', {'gameId': item.id}) }}">Partners</a>
                        </td>
                        <td class="text-center">
                            <a href="javascript:void(0);" id="lnk-clear-old-publisher-{{ item.id }}" class="lnk-clear-old-publisher">Clear old publisher</a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

        {% endif %}

    </div>

</div>

<script>

    var publisherName = '{{ PublisherName }}';

    $('.lnk-clear-old-publisher').on('click', function() {

        $('#js-admin-notify').hide();

        elemId = $(this).attr('id');
        gameId = elemId.replace('lnk-clear-old-publisher-', '');

        if (gameId == '') {
            $('#js-admin-notify').text('Missing gameId');
            $('#js-admin-notify').show();
            return false;
        }

        if (!window.confirm('CLear the old publisher field for this game? There is NO undo!')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('staff.stats.gamesCompany.clearOldPublisherField') }}', {'gameId': gameId}, function(data) {
            $('#lnk-clear-old-publisher-' + gameId).parent().html('<em>Old pub cleared</em>');
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#js-btn-add-all-new').on('click', function() {

        $('#js-admin-notify').hide();

        if (!window.confirm('Add all new publisher records for the listed games? There is NO undo!')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('staff.stats.gamesCompany.addAllNewPublishers') }}', {'publisherName': publisherName}, function(data) {
            $('#table-publisher-list tbody').children('tr').each(function() {
                // id 3 is the Publisher (new) column
                var $requiredCell = $(this).children('td').eq(3);
                $($requiredCell).html('<em>Updated</em>');
            });
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });

    $('#js-btn-remove-all-old').on('click', function() {

        $('#js-admin-notify').hide();

        if (!window.confirm('Clear the old publisher field for the listed games? There is NO undo!')) {
            return false;
        }

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="csrf-token"]').attr('content')
            }
        });

        $.getJSON('{{ route('staff.stats.gamesCompany.removeAllOldPublishers') }}', {'publisherName': publisherName}, function(data) {
            $('#table-publisher-list tbody').children('tr').each(function() {
                // id 3 is the Publisher (old) column
                var $requiredCell = $(this).children('td').eq(2);
                $($requiredCell).html('<em>Cleared</em>');
            });
        })
        .fail(function(data) {
            $('#js-admin-notify').text('An error occurred: ' + data.responseJSON.error);
            $('#js-admin-notify').show();
        });
    });
</script>

{% endblock page_inner %}
